/*! jquery.valiant360 - v0.2.2 - 2014-07-28
 * Copyright (c) 2014 Charlie Hoey <me@charliehoey.com>; Licensed MIT */
var Detector={canvas:!!window.CanvasRenderingContext2D,webgl:function(){try{var a=document.createElement("canvas");return!!window.WebGLRenderingContext&&(a.getContext("webgl")||a.getContext("experimental-webgl"))}catch(b){return!1}}(),workers:!!window.Worker,fileapi:window.File&&window.FileReader&&window.FileList&&window.Blob,getWebGLErrorMessage:function(){var a=document.createElement("div");return a.id="webgl-error-message",a.style.fontFamily="monospace",a.style.fontSize="13px",a.style.fontWeight="normal",a.style.textAlign="center",a.style.background="#fff",a.style.color="#000",a.style.padding="1.5em",a.style.width="400px",a.style.margin="5em auto 0",this.webgl||(a.innerHTML=window.WebGLRenderingContext?['Your graphics card does not seem to support <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation" style="color:#000">WebGL</a>.<br />','Find out how to get it <a href="http://get.webgl.org/" style="color:#000">here</a>.'].join("\n"):['Your browser does not seem to support <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation" style="color:#000">WebGL</a>.<br/>','Find out how to get it <a href="http://get.webgl.org/" style="color:#000">here</a>.'].join("\n")),a},addGetWebGLMessage:function(a){var b,c,d;a=a||{},b=void 0!==a.parent?a.parent:document.body,c=void 0!==a.id?a.id:"oldie",d=Detector.getWebGLErrorMessage(),d.id=c,b.appendChild(d)}};!function(){function a(a){q=this,this.options=$.extend({},v,a),r=this.options.lat,s=this.options.lon,t=this.options.fov,this.options.hideControls,n=new THREE.Scene,m=new THREE.PerspectiveCamera(this.options.fov,this.width()/this.height(),.1,1e3),o=Detector.webgl?new THREE.WebGLRenderer:new THREE.CanvasRenderer,o.setSize(this.width(),this.height()),o.autoClear=!1,o.setClearColor(16777215,1),this.append(o.domElement),$(q).attr("data-photo-src")?(p=THREE.ImageUtils.loadTexture($(q).attr("data-photo-src")),y=!0,j()):(x=document.createElement("video"),x.loop=this.options.loop,x.muted=this.options.muted,p=new THREE.Texture(x)),p.generateMipmaps=!1,p.minFilter=THREE.LinearFilter,p.magFilter=THREE.LinearFilter,p.format=THREE.RGBFormat,mesh=new THREE.Mesh(new THREE.SphereGeometry(500,80,50),new THREE.MeshBasicMaterial({map:p})),mesh.scale.x=-1,n.add(mesh),x?(x.addEventListener("ended",function(){l("video loaded")}),x.addEventListener("progress",function(){var a=null;x&&x.buffered&&x.buffered.length>0&&x.buffered.end&&x.duration?a=x.buffered.end(0)/x.duration:x&&void 0!=x.bytesTotal&&x.bytesTotal>0&&void 0!=x.bufferedBytes&&(a=x.bufferedBytes/x.bytesTotal);Math.round(100*a)}),x.addEventListener("canplaythrough",function(){1==q.options.autoplay&&x.play(),j(),l("playing")}),x.src=this.attr("data-video-src")):0!=y&&(y.onload=j,y.crossOrigin="anonymous",y.src=$(q).attr("data-photo-src"))}function b(){var a=q.options.muted?"fa-volume-off":"fa-volume-up",b=q.options.autoplay?"fa-pause":"fa-play";C=' 	        <div class="controls"> 	            <a href="#" class="playButton button fa '+b+'"></a> 	            <a href="#" class="muteButton button fa '+a+'"></a> 	            <a href="#" class="fullscreenButton button fa fa-expand"></a> 	        </div> 	    ',this.append(C,!0),this.options.hideControls&&$(q).find(".controls").hide(),c()}function c(){function a(){A=!1}function b(a){A=!0,B.x=a.pageX,B.y=a.pageY}function c(a){if(onPointerDownPointerX=a.clientX,onPointerDownPointerY=-a.clientY,onPointerDownLon=s,onPointerDownLat=r,q.options.clickAndDrag){if(A){var b=a.pageX-B.x,c=a.pageY-B.y;B.x=a.pageX,B.y=a.pageY,s+=b,r-=c}}else if($(q).is(":hover")){var b=a.pageX-$(q).find("canvas").offset().left,c=a.pageY-$(q).find("canvas").offset().top;s=b/$(q).find("canvas").width()*430-225,r=c/$(q).find("canvas").height()*-180+90}}function d(a){var b=-.01;a.wheelDeltaY?t-=a.wheelDeltaY*b:a.wheelDelta?t-=a.wheelDelta*b:a.detail&&(t+=1*a.detail);var c=3,d=100;c>t?t=c:t>d&&(t=d),$(q).is(":hover")&&(m.setLens(t),a.preventDefault())}document.addEventListener("mousemove",c,!1),document.addEventListener("mousewheel",d,!1),document.addEventListener("mousedown",b,!1),document.addEventListener("mouseup",a,!1),document.addEventListener("DOMMouseScroll",d,!1),$(q).find(".playButton").click(function(a){a.preventDefault(),$(this).hasClass("fa-pause")?($(this).removeClass("fa-pause").addClass("fa-play"),g()):($(this).removeClass("fa-play").addClass("fa-pause"),f())}),$(q).find(".pauseButton").click(function(a){a.preventDefault(),g()}),$(q).find(".fullscreenButton").click(function(a){a.preventDefault();var b=$(q)[0];$(this).hasClass("fa-expand")?b.requestFullscreen?b.requestFullscreen():b.msRequestFullscreen?b.msRequestFullscreen():b.mozRequestFullScreen?b.mozRequestFullScreen():b.webkitRequestFullscreen&&b.webkitRequestFullscreen():b.requestFullscreen?document.exitFullscreen():b.msRequestFullscreen?document.msExitFullscreen():b.mozRequestFullScreen?document.mozCancelFullScreen():b.webkitRequestFullscreen&&document.webkitExitFullscreen()}),$(q).find(".muteButton").click(function(a){a.preventDefault(),$(this).hasClass("fa-volume-off")?($(this).removeClass("fa-volume-off").addClass("fa-volume-up"),x.muted=!1):($(this).removeClass("fa-volume-up").addClass("fa-volume-off"),x.muted=!0)})}function d(){!window.screenTop&&!window.screenY&&$(q).find("a.fa-expand").length>0?(e(screen.width,screen.height),$(q).addClass("fullscreen"),$(q).find("a.fa-expand").removeClass("fa-expand").addClass("fa-compress"),z=!0):(e(q.originalWidth,q.originalHeight),$(q).removeClass("fullscreen"),$(q).find("a.fa-compress").removeClass("fa-compress").addClass("fa-expand"),z=!1)}function e(a,b){o.setSize(a,b),m.aspect=a/b,m.updateProjectionMatrix()}function f(){x.play()}function g(){x.pause()}function h(a){x.src=a}function i(a){y.src=a}function j(){if(requestAnimationFrame(j),x.readyState===x.HAVE_ENOUGH_DATA&&!y&&"undefined"!=typeof p){var a=(new Date).getTime();a-w>=30&&(p.needsUpdate=!0,w=a)}k()}function k(){r=Math.max(-85,Math.min(85,r)),phi=(90-r)*Math.PI/180,theta=s*Math.PI/180;var a=500*Math.sin(phi)*Math.cos(theta),b=500*Math.cos(phi),c=500*Math.sin(phi)*Math.sin(theta);m.lookAt(new THREE.Vector3(a,b,c)),q.options.flatProjection?(m.position.x=0,m.position.y=0,m.position.z=0):(m.position.x=-a,m.position.y=-b,m.position.z=-c),o.clear(),o.render(n,m)}function l(a){console.info(a)}var m,n,o,p,q,r,s,t,u={play:f,stop:g,fullscreen:d,loadVideo:h,loadPhoto:i},v={clickAndDrag:!1,fov:35,hideControls:!1,lon:0,lat:0,loop:"loop",muted:!0,debug:!1,flatProjection:!1,autoplay:!0},w=(new Date).getTime(),x=!1,y=!1,z=!1,A=!1,B={},C="";$.fn.Valiant360=function(){if("string"==typeof arguments[0]){var c=(arguments[1],Array.prototype.slice.call(arguments));c.splice(0,1),u[arguments[0]].apply(this,c)}else a.apply(this,arguments),b.apply(this,arguments);return this.originalWidth=$(this).find("canvas").width(),this.originalHeight=$(this).find("canvas").height(),$(q).addClass("Valiant360_default"),this},$(window).resize(function(){e($(q).width(),$(q).height())}),$(document).on("webkitfullscreenchange mozfullscreenchange fullscreenchange",d)}(jQuery);